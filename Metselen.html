<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8">
  <title>Metselverband Simulator ‚Äì Wienerberger Canvas</title>
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 1000px;
      margin: auto;
      padding: 20px;
    }
    .input-group {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 10px;
      margin-bottom: 12px;
    }
    label {
      font-size: 13px;
      font-weight: bold;
      display: flex;
      align-items: center;
    }
    input, select {
      width: 90px;
      margin-left: 6px;
      padding: 2px;
    }
    button {
      margin-top: 12px;
      padding: 8px 18px;
      background: #2c7be5;
      color: #fff;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    button:hover { background: #1a68d1; }
    #result {
      margin-top: 15px;
      padding: 10px;
      background: #f8f9fa;
      border-radius: 4px;
      font-weight: bold;
    }
    canvas {
      margin-top: 20px;
      border: 1px solid #666;
      background: #ffffff;
      display: block;
      width: 100%;
      max-width: 900px;
      height: auto;
    }
  </style>
</head>
<body>

<h2>Metselverband Simulator ‚Äì Wienerberger (Canvas)</h2>
<p><small>Rij 0 = onderste rij ‚Ä¢ Rechte randen ‚Ä¢ Alleen 1 / ¬æ / ¬Ω stenen</small></p>

<div class="input-group">
  <label>Muurhoogte (mm) <input id="H" type="number" value="520" min="50" max="5000"></label>
  <label>Muurbreedte (mm) <input id="B" type="number" value="1000" min="100" max="5000"></label>
  <label>Steen lengte <input id="L" type="number" value="210" min="100" max="400"></label>
  <label>Steen breedte <input id="D" type="number" value="100" min="50" max="200"></label>
  <label>Steen hoogte <input id="h" type="number" value="65" min="30" max="150"></label>
  <label>Lintvoeg <input id="lv" type="number" value="10" min="0" max="30"></label>
  <label>Lintvoeg onder rij 0 <input id="lv0" type="number" value="10" min="0" max="30"></label>
  <label>Stootvoeg <input id="sv" type="number" value="10" min="0" max="30"></label>
  <label>Verband
    <select id="verband">
      <option value="halfsteen">Halfsteensverband</option>
      <option value="kruis">Kruisverband</option>
      <option value="stapel">Stapelverband</option>
      <option value="wild">Wildverband</option>
      <option value="staand">Staand verband</option>
      <option value="klezoor">Klezoorverband</option>
      <option value="ketting">Kettingverband</option>
      <option value="claustra">Claustra</option>
    </select>
  </label>
</div>

<button id="bereken">Bereken & Visualiseer</button>
<div id="result"></div>
<canvas id="canvas"></canvas>

<script>
function drawStone(ctx, x, yFromBottom, w, h, color, H, scale) {
  // yFromBottom = afstand van onderkant muur (in mm)
  const yCanvas = (H - (yFromBottom + h)) * scale; // want canvas-y = van boven
  ctx.fillStyle = color;
  ctx.fillRect(x * scale, yCanvas, w * scale, h * scale);
  ctx.strokeStyle = '#333';
  ctx.lineWidth = 0.5;
  ctx.strokeRect(x * scale, yCanvas, w * scale, h * scale);
}

function getValidSize(width, base) {
  const options = [
    { size: base, type: 'full' },
    { size: 0.75 * base, type: 'threeq' },
    { size: 0.5 * base, type: 'half' }
  ];
  let best = null;
  for (const opt of options) {
    if (opt.size <= width + 0.1 && (!best || opt.size > best.size)) {
      best = opt;
    }
  }
  return best || { size: base, type: 'full' };
}

function buildRow(verband, rowIndex, L, D, maxB, sv) {
  const stones = [];
  let x = 0;
  let sequence = [];

  switch (verband) {
    case 'halfsteen':
      if (rowIndex % 2 === 0) sequence = [{ isKop: false, base: L }];
      else {
        stones.push({ x: 0, width: L/2, isKop: false, type: 'half' });
        x = L/2 + sv;
        sequence = [{ isKop: false, base: L }];
      }
      break;
    case 'kruis':
      if (rowIndex % 2 === 0) sequence = [{ isKop: false, base: L }];
      else sequence = [{ isKop: true, base: D }];
      break;
    case 'stapel':
    case 'wild':
      sequence = [{ isKop: false, base: L }];
      break;
    case 'staand':
      sequence = [{ isKop: true, base: D }];
      break;
    case 'klezoor':
      sequence = [{ isKop: false, base: L }, { isKop: true, base: D }];
      break;
    case 'ketting':
      sequence = [{ isKop: false, base: L }, { isKop: false, base: L }, { isKop: true, base: D }];
      break;
    case 'claustra':
      while (x < maxB + L + sv) {
        stones.push({ x, width: L, isKop: false, type: 'full' });
        x += L + sv;
        x += L + sv; // opening
      }
      return stones;
    default:
      sequence = [{ isKop: false, base: L }];
  }

  if (verband === 'claustra') return stones;

  let idx = 0;
  while (x < maxB + L + sv) {
    const item = sequence[idx % sequence.length];
    const rest = maxB + L + sv - x;
    const valid = getValidSize(rest, item.base);
    stones.push({ x, width: valid.size, isKop: item.isKop, type: valid.type });
    x += valid.size + sv;
    idx++;
    if (idx > 50) break;
  }
  return stones;
}

$('#bereken').on('click', function () {
  const H = +$('#H').val();     // totale muurhoogte
  const B = +$('#B').val();     // muurbreedte
  const L = +$('#L').val();     // strek (lengte)
  const D = +$('#D').val();     // kop (breedte)
  const h = +$('#h').val();     // steenhoogte
  const lv = +$('#lv').val();   // lintvoeg tussen rijen
  const lv0 = +$('#lv0').val(); // lintvoeg onder rij 0 (onderste rij)
  const sv = +$('#sv').val();
  const verband = $('#verband').val();

  if ([H, B, L, D, h, lv, lv0, sv].some(isNaN) || H <= 0 || B <= 0 || L <= 0 || D <= 0 || h <= 0 || lv < 0 || lv0 < 0 || sv < 0) {
    $('#result').html('‚ùå Fout: alle waarden moeten positief getallen zijn.');
    return;
  }

  // === Bepaal max aantal rijen dat past van onder naar boven ===
  let rijen = 0;
  while (true) {
    // Hoogte nodig voor (rijen + 1) rijen:
    // = lv0 + (rijen+1)*h + (rijen)*lv
    const needed = lv0 + (rijen + 1) * h + rijen * lv;
    if (needed <= H) {
      rijen++;
    } else {
      break;
    }
    if (rijen > 200) break;
  }

  const canvas = document.getElementById('canvas');
  const ctx = canvas.getContext('2d');
  const viewWidth = B + Math.max(L, D) + 100;
  const scale = Math.min(canvas.clientWidth / viewWidth, 800 / viewWidth);
  canvas.width = viewWidth * scale;
  canvas.height = H * scale;

  // Teken muurgrens (0,0 = linksonder in mm ‚Üí canvas: y = H*scale - y_mm*scale)
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  ctx.strokeStyle = '#ff0000';
  ctx.setLineDash([5, 5]);
  ctx.lineWidth = 1;
  ctx.strokeRect(0, 0, B * scale, H * scale);
  ctx.setLineDash([]);

  const count = { full: 0, threeq: 0, half: 0 };
  const colorMap = { full: '#c2b280', threeq: '#aa9a60', half: '#b5a570' };

  // Teken rijen van onder naar boven (rij 0 = onderste)
  for (let r = 0; r < rijen; r++) {
    // yFromBottom = afstand van onderkant tot onderkant van deze rij
    const yFromBottom = lv0 + r * (h + lv);
    const row = buildRow(verband, r, L, D, B, sv);

    for (const stone of row) {
      if (stone.x > B + Math.max(L, D) + 50) continue;

      const exceedsWidth = stone.x + stone.width > B;
      const exceedsHeight = yFromBottom + h > H; // zou niet mogen bij correcte rij-berekening, maar veiligheid
      const isOutside = exceedsWidth || exceedsHeight;

      if (!isOutside) {
        count[stone.type]++;
      }

      const color = isOutside ? '#ff6b6b' : colorMap[stone.type] || '#c2b280';
      drawStone(ctx, stone.x, yFromBottom, stone.width, h, color, H, scale);
    }
  }

  // === Suggesties ===
  let suggestions = '';

  // Stootvoeg suggestie voor rij 0 (onderste rij) met volle stenen
  const base0 = (verband === 'staand' || (verband === 'kruis' && 0 % 2 === 1)) ? D : L;
  let bestSv = null;
  for (let n = 1; n <= Math.ceil(B / base0) + 3; n++) {
    if (n === 1) {
      if (Math.abs(base0 - B) <= 1) { bestSv = sv; break; }
    } else {
      const candidate = (B - n * base0) / (n - 1);
      if (candidate >= 0 && candidate <= 30) { bestSv = candidate; break; }
    }
  }
  if (bestSv !== null && Math.abs(bestSv - sv) > 0.5) {
    suggestions += `üí° Voor exacte breedte met volle stenen in rij 0: stootvoeg = ${bestSv.toFixed(1)} mm<br>`;
  }

  // Suggestie voor lv0 voor exacte hoogte
  if (rijen > 0) {
    const usedHeight = lv0 + rijen * h + (rijen - 1) * lv;
    const diff = H - usedHeight;
    if (Math.abs(diff) > 0.5) {
      const newLv0 = lv0 + diff;
      if (newLv0 >= 0 && newLv0 <= h / 2) {
        suggestions += `üí° Voor exacte hoogte: pas lintvoeg onder rij 0 aan naar ${newLv0.toFixed(1)} mm (‚â§¬Ω steen)<br>`;
      }
    }
  }

  // Resultaat
  const total = count.full + count.threeq + count.half;
  let resultText = `Ingevoerde waarden:<br>`;
  resultText += `&nbsp;&nbsp;H=${H} mm, B=${B} mm<br>`;
  resultText += `&nbsp;&nbsp;lv=${lv} mm, lv0=${lv0} mm, sv=${sv} mm<br><br>`;
  resultText += `Aantal rijen (van onder): ${rijen}<br>`;
  resultText += `Volle stenen (binnen muur): ${count.full}<br>`;
  resultText += `¬æ-stenen: ${count.threeq}<br>`;
  resultText += `Halve stenen: ${count.half}<br>`;
  resultText += `Totaal binnen muur: ${total}<br><br>`;

  if (suggestions) resultText += suggestions;
  resultText += `‚úÖ Rode stenen vallen buiten de muurafmetingen.<br>`;
  resultText += `üìè Gestippelde rechthoek = opgegeven muur (B√óH).`;

  $('#result').html(resultText);
});
</script>
</body>
</html>
