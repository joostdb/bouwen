<!DOCTYPE html>
<html lang="nl">
<head>
<meta charset="UTF-8">
<title>Metselverband Simulator – 3D</title>

<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.160.1/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.160.1/examples/js/controls/OrbitControls.js"></script>

<style>
body {
  font-family: Arial, sans-serif;
  max-width: 1200px;
  margin: auto;
  padding: 15px;
}
.input-group {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
  gap: 10px;
  margin-bottom: 12px;
}
label {
  font-size: 13px;
  font-weight: bold;
  display: flex;
  align-items: center;
}
input, select {
  width: 90px;
  margin-left: 6px;
}
button {
  margin-top: 12px;
  padding: 8px 18px;
  background: #2c7be5;
  color: #fff;
  border: none;
  border-radius: 4px;
  cursor: pointer;
}
#scene-container {
  width: 100%;
  height: 520px;
  margin-top: 20px;
  border: 1px solid #ccc;
  background: #eee;
}
</style>
</head>

<body>

<h2>Metselverband Simulator – 3D</h2>

<div class="input-group">
  <label>Hoogte <input id="H" type="number" value="520"></label>
  <label>Breedte <input id="B" type="number" value="1000"></label>
  <label>Steen L <input id="L" type="number" value="210"></label>
  <label>Steen D <input id="D" type="number" value="100"></label>
  <label>Steen h <input id="h" type="number" value="65"></label>
  <label>Lintvoeg <input id="lv" type="number" value="10"></label>
  <label>Lintvoeg 0 <input id="lv0" type="number" value="10"></label>
  <label>Stootvoeg <input id="sv" type="number" value="10"></label>
  <label>Verband
    <select id="verband">
      <option value="halfsteen">Halfsteens</option>
      <option value="kruis">Kruis</option>
      <option value="stapel">Stapel</option>
      <option value="wild">Wild</option>
      <option value="staand">Staand</option>
      <option value="klezoor">Klezoor</option>
      <option value="ketting">Ketting</option>
      <option value="claustra">Claustra</option>
    </select>
  </label>
</div>

<button id="bereken">Genereer</button>
<div id="result"></div>
<div id="scene-container"></div>

<script>
const EPS = 1e-6;
let renderer = null;

function validStone(rest, base) {
  const sizes = [
    { size: base, type: 'full' },
    { size: 0.75 * base, type: 'threeq' },
    { size: 0.5 * base, type: 'half' }
  ];
  return sizes.find(s => s.size <= rest + EPS) || null;
}

function buildRow(verband, r, L, D, B, sv) {
  const stones = [];
  let x = 0;

  const push = (w, isKop, type) => {
    stones.push({ x, width: w, isKop, type });
    x += w + sv;
  };

  if (r === 0) {
    while (x + L <= B + EPS) push(L, false, 'full');
    return stones;
  }

  const halfOffset = (r % 2 && verband === 'halfsteen') ? L / 2 + sv : 0;
  if (halfOffset && halfOffset <= B) {
    stones.push({ x: 0, width: L / 2, isKop: false, type: 'half' });
    x = halfOffset;
  }

  let i = 0;
  while (x < B - EPS && stones.length < 200) {
    let isKop = false;
    if (verband === 'kruis') isKop = r % 2;
    if (verband === 'staand') isKop = true;
    if (verband === 'klezoor') isKop = i % 2;
    if (verband === 'ketting') isKop = i % 3 === 2;
    if (verband === 'claustra' && i % 2 === 1) {
      x += L + sv;
      i++;
      continue;
    }

    const base = isKop ? D : L;
    const rest = B - x;
    const v = validStone(rest, base);
    if (!v) break;

    push(v.size, isKop, v.type);
    i++;
  }

  return stones;
}

$('#bereken').on('click', () => {
  const H = +H.value, B = +B.value, L = +L.value, D = +D.value;
  const h = +h.value, lv = +lv.value, lv0 = +lv0.value, sv = +sv.value;
  const verband = $('#verband').val();

  let rows = 0;
  while (lv0 + (rows + 1) * h + rows * lv <= H + EPS) rows++;

  const stones = [];
  for (let r = 0; r < rows; r++) {
    const y = lv0 + r * (h + lv);
    for (const s of buildRow(verband, r, L, D, B, sv)) {
      stones.push({
        x: s.x,
        y,
        width: s.width,
        height: h,
        depth: s.isKop ? L : D,
        type: s.type
      });
    }
  }

  $('#result').text(`${stones.length} stenen · ${rows} rijen`);
  render(stones, B, H);
});

function render(stones, BW, BH) {
  const container = document.getElementById('scene-container');
  if (renderer) {
    renderer.dispose();
    container.innerHTML = '';
  }

  const scene = new THREE.Scene();
  scene.background = new THREE.Color(0xf0f0f0);

  const camera = new THREE.PerspectiveCamera(
    50,
    container.clientWidth / container.clientHeight,
    1,
    5000
  );
  camera.position.set(BW / 2, BH / 2, BW * 1.2);

  renderer = new THREE.WebGLRenderer({ antialias: true });
  renderer.setSize(container.clientWidth, container.clientHeight);
  container.appendChild(renderer.domElement);

  const controls = new THREE.OrbitControls(camera, renderer.domElement);
  controls.enableDamping = true;

  scene.add(new THREE.AmbientLight(0x888888));
  const light = new THREE.DirectionalLight(0xffffff, 1);
  light.position.set(1, 2, 3);
  scene.add(light);

  const mats = {
    full: new THREE.MeshLambertMaterial({ color: 0xc2b280 }),
    threeq: new THREE.MeshLambertMaterial({ color: 0xaa9a60 }),
    half: new THREE.MeshLambertMaterial({ color: 0xb5a570 })
  };

  stones.forEach(s => {
    const mesh = new THREE.Mesh(
      new THREE.BoxGeometry(s.width, s.height, s.depth),
      mats[s.type]
    );
    mesh.position.set(
      s.x + s.width / 2,
      s.y + s.height / 2,
      s.depth / 2
    );
    scene.add(mesh);
  });

  scene.add(new THREE.LineSegments(
    new THREE.EdgesGeometry(new THREE.BoxGeometry(BW, BH, 10)),
    new THREE.LineBasicMaterial({ color: 0xff0000 })
  )).position.set(BW / 2, BH / 2, 5);

  (function animate() {
    requestAnimationFrame(animate);
    controls.update();
    renderer.render(scene, camera);
  })();

  window.onresize = () => {
    camera.aspect = container.clientWidth / container.clientHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(container.clientWidth, container.clientHeight);
  };
}
</script>

</body>
</html>
